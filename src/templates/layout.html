<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>LifePIM - {{ active_tab }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='lifepim.css') }}">
</head>
{% set current_proj = request.args.get('proj') %}
{% if current_proj in ['any', 'All', 'all', 'ALL', 'spacer'] %}
  {% set current_proj = None %}
{% endif %}
{% set sidebar_label = current_proj or 'All Projects' %}
<body data-active-tab="{{ active_tab }}" data-sidebar-label="{{ sidebar_label }}" data-sidebar-id="{{ current_proj or '' }}">
  <div class="topbar">
    <!-- Hamburger dropdown menu -->
    <div class="menu-wrapper">
      <button class="menu-btn" id="menuToggle">â˜°</button>
      <div class="dropdown-menu" id="menuDropdown">
        <a href="#" id="showSidebar">Show project list</a>
        <a href="#" id="hideSidebar">Hide project list</a>
        <a href="#">Edit projects</a>
        <div class="menu-spacer"></div>
        <a href="#">Settings</a>
        <a href="#">Help</a>
        <a href="{{ url_for('admin.user_history_route') }}">User history</a>
      </div>
    </div>

    <div class="top-nav-container">
      {% for t in tabs %}
        {% set tab_href = '/' if t.id == 'home' else '/' ~ t.id %}
        <a class="top-tab-item {% if t.id==active_tab %}active{% endif %}" href="{{ tab_href }}{% if current_proj %}?proj={{ current_proj }}{% endif %}" title="{{t.desc}}">
          <span class="ic">{{t.icon}}</span><span class="lab">{{t.label}}</span>
        </a>
      {% endfor %}
    </div>
    {% set search_scope = request.args.get('scope', 'titles') %}
    <form class="search-form" action="{{ url_for('search_route') }}" method="get">
      <input type="text" name="q" value="{{ request.args.get('q', '') }}" placeholder="Search">
      <input type="hidden" name="proj" value="{{ current_proj or '' }}">
      <input type="hidden" name="route" value="{{ active_tab }}">
      <button type="submit">Search</button>
      <select name="scope" title="Search scope">
        <option value="titles" {% if search_scope != 'all' %}selected{% endif %}>Titles</option>
        <option value="all" {% if search_scope == 'all' %}selected{% endif %}>All</option>
      </select>
    </form>
  </div>

  <div class="container">
    <aside class="side-tabs" id="sidebar">
      {% for s in side_tabs %}
        {% set tab_proj = (s.proj if s.proj is defined and s.proj else s.id) %}
        {% set is_all = tab_proj in ['any', 'All', 'all', 'ALL'] %}
        {% set is_active = (current_proj and tab_proj and tab_proj|lower == current_proj|lower) or (not current_proj and is_all) %}
        <a class="side {% if is_active %}active{% endif %}" href="/{{active_tab}}{% if tab_proj not in ['any', 'All', 'all', 'ALL', 'spacer'] %}?proj={{tab_proj}}{% endif %}">
          <span class="ic">{{s.icon}}</span>
          <span class="lab">{{s.label}}</span>
        </a>
      {% endfor %}
    </aside>

    <main class="main">
      <h3>{{ content_title or active_tab }}</h3>
      <div class="content">
        {{ content_html|safe }}
      </div>
      {% block module_content %}{% endblock %}
    </main>
  </div>

  {% include "widgets/links_overlay.html" %}
  {% include "widgets/note_overlay.html" %}

  <script>
    const menuToggle = document.getElementById('menuToggle');
    const menuDropdown = document.getElementById('menuDropdown');
    const sidebar = document.getElementById('sidebar');
    const showSidebar = document.getElementById('showSidebar');
    const hideSidebar = document.getElementById('hideSidebar');

    // Toggle dropdown visibility
    menuToggle.addEventListener('click', () => {
      menuDropdown.classList.toggle('show');
    });

    // Hide dropdown if clicking outside
    window.addEventListener('click', (e) => {
      if (!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) {
        menuDropdown.classList.remove('show');
      }
    });

    // Sidebar show/hide actions
    showSidebar.addEventListener('click', (e) => {
      e.preventDefault();
      sidebar.classList.remove('hidden');
      menuDropdown.classList.remove('show');
    });

    hideSidebar.addEventListener('click', (e) => {
      e.preventDefault();
      sidebar.classList.add('hidden');
      menuDropdown.classList.remove('show');
    });
  </script>
  <script src="{{ url_for('static', filename='links.js') }}"></script>
  <script src="{{ url_for('static', filename='notes.js') }}"></script>
</body>
</html>
